{
  order token first
  {{- if .Values.caddy.payloadsize.enabled }}
  order payloadsize after token
  {{- end }}
  admin :2019

  servers {
    metrics
  }

  storage file_system {
    root /data
}
}



# Define common application logic as a snippet
(app_logic) {

  handle /api/health {
    header Content-Type application/json
    respond "{\"status\": \"UP\"}" 200
  }

  handle {
      # authn
      token {
        {{- if .Values.authn.oidc.enabled }}
        jwt {
           issuer {{ .Values.authn.oidc.issuer }}
        }
        {{- end }}
        {{- if .Values.authn.staticTokens.enabled }}
        file /var/lib/caddy/tokens
        {{- end }}
        {{- if .Values.authn.signedTokens.enabled }}
        signed {
          key {$SIGNING_KEY}
        }
        {{- end }}
        {{- if .Values.authn.clientCa.enabled }}
        client_ca {
          debug {{ .Values.authn.clientCa.debug }}
          default_org "anonymous"
        }
        {{- end }}
      }

      {{- if .Values.caddy.payloadsize.enabled }}
      payloadsize {
        {{- if .Values.billing.enabled }}
        tenant_mapper_url {{ .Values.billing.tenantMapperUrl }}
        {{- end }}
      }
      {{- end }}

      {{- if .Values.loki.enabled }}
      # logs
      reverse_proxy {{ .Values.loki.pathPrefix }} {
        to {{ .Values.loki.service }}
        @204 {
           status 204
        }
        handle_response @204 {
           copy_response 200
        }
        rewrite /otlp/v1/logs
      }

      # loki direct access
      reverse_proxy /loki/api/v1/push {
        to {{ .Values.loki.service }}
      }
      {{- end }}

      {{- if .Values.mimir.enabled }}
      # metrics
      reverse_proxy {{ .Values.mimir.pathPrefix }} {
        to {{ .Values.mimir.service }}
        rewrite /otlp/v1/metrics
      }

      # mimir direct access
      reverse_proxy /mimir/api/v1/push {
        to {{ .Values.mimir.service }}
        rewrite /api/v1/push
      }
      {{- end }}

      {{- if .Values.tempo.enabled }}
      # traces
      reverse_proxy {{ .Values.tempo.pathPrefix }} {
        to {{ .Values.tempo.service }}
      }
      {{- end }}

      {{- if .Values.pyroscope.enabled }}
      # profiling
      reverse_proxy {{ .Values.pyroscope.pathPrefix }} {
        to {{ .Values.pyroscope.service }}
        rewrite /ingest
      }

      reverse_proxy {{ .Values.pyroscope.pathPrefix }}/push {
        to {{ .Values.pyroscope.service }}
        rewrite /push.v1.PusherService/Push
      }
      {{- end }}

      {{- if .Values.ruler.enabled }}
      # ruler
      handle_path {{ .Values.ruler.pathPrefix }}* {
        reverse_proxy {{ .Values.ruler.service }}
      }
      {{- end }}

      {{- if .Values.prometheus.enabled }}
      # prometheus otlp receiver
      reverse_proxy {{ .Values.prometheus.pathPrefix }} {
        to {{ .Values.prometheus.service }}
        rewrite /api/v1/otlp/v1/metrics
      }
      {{- end }}
  }
}

{{- if .Values.loadbalancer.enabled }}
# HTTP server - redirect to HTTPS for LoadBalancer mode
:8080 {
  log {
    output stdout
    level {{ .Values.log.level }}
    format filter {
      request>headers>X-Id-Token replace REDACTED
      request>headers>X-Api-Key replace REDACTED
    }
  }
  
  redir https://{{ .Values.environmentConfig.host }}.{{ .Values.environmentConfig.clusterFqdn }}{uri} permanent
}
{{- else }}
# HTTP server - direct handling for non-LoadBalancer mode
:8080 {
  log {
    output stdout
    level {{ .Values.log.level }}
    format filter {
      request>headers>X-Id-Token replace REDACTED
      request>headers>X-Api-Key replace REDACTED
    }
  }
  
  import app_logic
}
{{- end }}

{{- if .Values.loadbalancer.enabled }}
# HTTPS server - enabled only when LoadBalancer is enabled
:8443 {
  tls /etc/ssl/certs/tls.crt /etc/ssl/private/tls.key {
    {{- if .Values.authn.clientCa.enabled }}
    client_auth {
      mode {{ .Values.authn.clientCa.mode | default "verify_if_given" }}
      trust_pool file {
        pem_file /etc/ssl/client-ca/client_ca.pem
      }
    }
    {{- end }}
  }
  
  log {
    output stdout
    level {{ .Values.log.level }}
    format filter {
      request>headers>X-Id-Token replace REDACTED
      request>headers>X-Api-Key replace REDACTED
    }
  }
  
  import app_logic
}
{{- end }}
