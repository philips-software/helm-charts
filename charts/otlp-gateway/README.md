# otlp-gateway

![Version: 0.41.0](https://img.shields.io/badge/Version-0.41.0-informational?style=flat-square) ![Type: application](https://img.shields.io/badge/Type-application-informational?style=flat-square)

OTLP gateway is a reference implementation which creates a single otlphttp endpoint that proxies Loki, Tempo and Mimir OTLP endpoints
It supports authentication and authorization using both static and JWT tokens and tokens through the [caddy-token](https://github.com/loafoe/caddy-token) plugin.

## Scripts

### Adding signing key

To support signing keys we add a secret with a key string that will be used to verify signed API keys. You can use the provided script or create the secret manually:

**Using the script (recommended):**
```shell
./scripts/provision_signing_key.sh
```

**Manual creation:**
```shell
kubectl create secret generic otlp-gateway-signing-key --from-literal=key=Secr3TKeyH3re
```

### Adding client CA certificate

To support client certificate authentication, you need to provide a trusted CA certificate. Use the provided script to create or update the client CA secret:

```shell
./scripts/upsert_client_ca.sh /path/to/ca-chain.crt
```

This script will:
- Create the `otlp-gateway-client-ca` secret in the `otlp-gateway` namespace
- Store the CA certificate chain with key `client_ca.pem`
- Update existing secrets or create new ones as needed
- Verify the certificate format after creation/update

**Configuration:**
Enable client certificate authentication in your values.yaml:
```yaml
authn:
  client_ca:
    enabled: true
    secret: otlp-gateway-client-ca
    # Authentication mode options:
    # - request: Request client cert but don't verify
    # - require: Require client cert but don't verify
    # - verify_if_given: Verify client cert if provided (default)
    # - require_and_verify: Require and verify client cert
    mode: verify_if_given
```

## Values

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| authn.clientCa.debug | bool | `false` |  |
| authn.clientCa.enabled | bool | `false` |  |
| authn.clientCa.mode | string | `"verify_if_given"` |  |
| authn.clientCa.secret | string | `"otlp-gateway-client-ca"` |  |
| authn.oidc.enabled | bool | `false` |  |
| authn.oidc.issuer | string | `"https://issuer.obs-us-east-ct.hsp.philips.com"` |  |
| authn.signedTokens.enabled | bool | `true` |  |
| authn.signedTokens.secret | string | `"otlp-gateway-signing-key"` |  |
| authn.staticTokens.enabled | bool | `false` |  |
| authn.staticTokens.secret | string | `"otlp-gateway-static-tokens"` |  |
| autoscaling.enabled | bool | `false` |  |
| autoscaling.maxReplicas | int | `5` |  |
| autoscaling.minReplicas | int | `2` |  |
| autoscaling.targetCPUUtilizationPercentage | int | `80` |  |
| autoscaling.targetMemoryUtilizationPercentage | int | `80` |  |
| billing.enabled | bool | `false` |  |
| billing.tenantMapperUrl | string | `"http://tenant-mapper.starlift-observability.svc.cluster.local"` |  |
| caddy.container.image | string | `"ghcr.io/loafoe/caddy-token:v0.77.0"` |  |
| caddy.payloadsize.enabled | bool | `false` |  |
| environmentConfig.clusterFqdn | string | `""` |  |
| environmentConfig.host | string | `"otlp-gateway"` |  |
| environmentConfig.region | string | `""` |  |
| httpRoute.enabled | bool | `false` |  |
| httpRoute.gateway.name | string | `"platform"` |  |
| httpRoute.gateway.namespace | string | `"kube-system"` |  |
| ingress.enabled | bool | `true` |  |
| loadbalancer.enabled | bool | `false` |  |
| log.level | string | `"error"` |  |
| loki.enabled | bool | `true` |  |
| loki.pathPrefix | string | `"/v1/logs"` |  |
| loki.service | string | `"loki-gateway.loki-system.svc.cluster.local:80"` |  |
| mimir.enabled | bool | `true` |  |
| mimir.pathPrefix | string | `"/v1/metrics"` |  |
| mimir.service | string | `"mimir-gateway.mimir-system.svc.cluster.local:80"` |  |
| prometheus.enabled | bool | `false` |  |
| prometheus.pathPrefix | string | `"/prometheus/v1/metrics"` |  |
| prometheus.service | string | `"kps-prometheus.prometheus.svc.cluster.local:9090"` |  |
| pyroscope.enabled | bool | `false` |  |
| pyroscope.pathPrefix | string | `"/v1/profiles"` |  |
| pyroscope.service | string | `"pyroscope.pyroscope-system.svc.cluster.local:4040"` |  |
| replicas | int | `3` |  |
| ruler.enabled | bool | `true` |  |
| ruler.pathPrefix | string | `"/ruler"` |  |
| ruler.service | string | `"mimir-ruler.mimir-system.svc.cluster.local:8080"` |  |
| tempo.enabled | bool | `true` |  |
| tempo.pathPrefix | string | `"/v1/traces"` |  |
| tempo.service | string | `"tempo-gateway.tempo-system.svc.cluster.local:80"` |  |

----------------------------------------------
Autogenerated from chart metadata using [helm-docs v1.14.2](https://github.com/norwoodj/helm-docs/releases/v1.14.2)
